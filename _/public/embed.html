<!DOCTYPE html>
<html>
<head>
  <title>Phynix Embed</title>
  <meta charset="utf-8">
  <style>
    html, body {
      width: 100%;
      height: 100%;
    }

    body {
      margin: 0;
    }

    #youtube-embed {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: 0;
      background: 0;
      outline: 0;
    }
  </style>
  <script src="//phynix.io/s/js/jquery.js" type="text/javascript"></script>
</head>
<body>
  <div id="youtube-embed"></div>
  <div id="soundcloud-embed"></div>
  <script>
    var tag = document.createElement('script');
 
    tag.src = "//www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    function getQueryStringValue (key) {  
      return unescape(window.location.search.replace(new RegExp("^(?:.*[&\\?]" + escape(key).replace(/[\.\+\*]/g, "\\$&") + "(?:\\=([^&]*))?)?.*$", "i"), "$1"));  
    }

    var types = {
      youtube: 1,
      soundcloud: 2
    }

    var current;
    var volume = 100;

    var youtube = new (function() {
      var frame;
      var player;
      var apiLoaded = false;

      window.onYouTubeIframeAPIReady = function() {
        apiLoaded = true;
      }

      this.destroy = function() {
        if (!player || !frame) return;
        player.stopVideo();
        frame.hide();
        console.info(frame);
      }

      this.load = function(id, start) {
        if (!apiLoaded) return setTimeout(function() {
          load(id, types.youtube, start);
        }, 10);

        if (player && player.loadVideoById)
          player.loadVideoById(id, start, 'large');
        else {
          player = new YT.Player('youtube-embed', {
            videoId: id,
            height: '100%',
            width: '100%',
            playerVars: {
              'autoplay': 1,
              'cc_load_policy': 0,
              'controls': 0,
              'disablekb': 0,
              'fs': 0,
              'iv_load_policy': 3,
              'modestbranding': 1,
              'rel': 0,
              'showinfo': 0,
              'start': ~~start
            },
            events: {
              'onReady': onReady,
              'onStateChange': onStateChange
            }
          });
        frame = $('#youtube-embed');
        }
        this.setVolume(volume);
        frame.show();
      }

      this.setVolume = function(volume) {
        if (player && player.setVolume)
          player.setVolume(volume);
      }

      function onReady(e) {
        setVolume(volume);
      }

      function onStateChange(e) {
        switch (e.data) {
          case YT.PlayerState.PAUSED:
            player.playVideo();
        }
      }
    });

    var soundcloud = new (function() {
      var frame = $('#soundcloud-embed');
      var audio;

      this.destroy = function() {
        if (audio) audio.pause();
        frame.hide();
      }

      this.load = function(id, start) {
        if (audio) {
          audio.src = 'https://api.soundcloud.com/tracks/' + id + '/stream?client_id=2d5a9eda4866bc2d96d385db39509df5';
          this.setVolume(volume);
          audio.play();
          return;
        }

        audio = new Audio('https://api.soundcloud.com/tracks/' + id + '/stream?client_id=2d5a9eda4866bc2d96d385db39509df5');
        audio.crossOrigin = 'anonymous';
        audio.currentTime = start || 0;
        audio.ontimeupdate = function(e) {
          window.parent.postMessage(JSON.stringify({
          e: 'timeUpdate',
          d: audio.currentTime
        }), location.origin);
        }
        this.setVolume(volume);
        audio.play();
        frame.show();
      }

      this.setVolume = function(volume) {
        if (audio)
          audio.volume = volume / 100
      }
    });

    function destroy() {
      if (!current) return;
      current.destroy();
    }

    function load(id, type, start) {
      if (current) destroy();

      var obj = {
        1: youtube,
        2: soundcloud
      }[type];

      if (!obj) return;

      current = obj;

      obj.load(id, start);
    }

    function setVolume(value) {
      console.info(value);
      volume = value;
      if (!current) return;
      current.setVolume(volume);
    }

    window.addEventListener('message', function(e) {
      var data;
      try {
        data = JSON.parse(e.data);
      } catch (e) { return console.error(e); }

      var origin = e.origin || e.originalEvent.origin;
      if (origin === 'https://www.youtube.com' && data.event === 'infoDelivery') {
       window.parent.postMessage(JSON.stringify({
          e: 'timeUpdate',
          d: data.info.currentTime
        }), location.origin);
        return;
      } else if (origin !== 'https://phynix.io') return;

      data = data;

      switch (data.a) {
        case 'destroy':
          destroy();
          break;
        case 'load':
          load(data.d.id, data.d.type, data.d.start);
          break;
        case 'setVolume':
          setVolume(data.d);
          break;
      }
    });

    var id = getQueryStringValue('id');
    var type = getQueryStringValue('type');
    var start = +getQueryStringValue('start');

    load({
      id: id,
      type: type,
      start: start
    });
  </script>
</body>
</html>